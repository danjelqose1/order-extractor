<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Extractor — Local</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;margin:24px;line-height:1.4}
    h1{font-size:20px;margin:0 0 12px}
    textarea{width:min(900px,100%);height:240px;padding:12px;border:1px solid #ddd;border-radius:8px}
    button{border:1px solid #ccc;background:#fafafa;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.primary{background:#f4f6ff;border-color:#cad2ff}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 8px}
    .summary{margin:12px 0;font-weight:600}
    table{border-collapse:collapse;margin-top:8px;width:min(1100px,100%);}
    th,td{border:1px solid #e7e7e7;padding:6px 8px;font-size:14px}
    th{background:#fbfbfb;text-align:left}
    .muted{color:#777}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f1f1;font-size:12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #ccc;border-top-color:#777;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{background:#fff0f0;border:1px solid #ffd6d6;padding:8px;border-radius:6px;margin-top:8px}
  </style>
</head>
<body>
  <h1>Order Extractor — Local</h1>
  <div class="muted">Paste the text you copied from the PDF, then click Extract.</div>
  <textarea id="input" placeholder="Paste order text here…"></textarea>
  <div class="controls">
    <button id="extract" class="primary">Extract</button>
    <button id="copyCsv">Copy CSV</button>
    <button id="downloadCsv">Download CSV</button>
    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="groupToggle">
      <span class="muted">Group identical sizes</span>
    </label>
    <button id="printLabels">Print Labels</button>
    <details id="logoPanel" style="margin-left:8px">
      <summary class="muted">Logos</summary>
      <div style="display:flex;gap:12px;align-items:center;margin-top:6px;flex-wrap:wrap">
        <label>logokeli.png <input type="file" id="logoKeli" accept="image/png" /></label>
        <label>ce.png <input type="file" id="logoCe" accept="image/png" /></label>
        <span class="muted" id="logoStatus"></span>
      </div>
      <div class="muted" style="margin-top:4px">Tip: you can also place <code>logokeli.png</code> / <code>ce.png</code> next to this file or in <code>assets/</code>. These pickers store logos locally (browser only).</div>
    </details>
    <span id="status" class="muted"></span>
  </div>
  <div id="orderInfo" class="muted"></div>
  <div id="summary" class="summary"></div>
  <div id="tableWrap"></div>
  <div id="error" class="error" style="display:none"></div>

<script>
const API_BASE = "https://order-extractor-kdih.onrender.com";
// --- data URL <-> bytes helpers for logo storage ---
function dataURLToBytes(dataUrl){
  try{
    const base64 = (dataUrl.split(',')[1] || '');
    const bin = atob(base64);
    const len = bin.length;
    const bytes = new Uint8Array(len);
    for(let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
    return bytes.buffer;
  }catch(e){ return null; }
}
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
// ---------- Label PDF: loader + helpers ----------
async function ensurePdfLib(){
  if (window.PDFLib) return;
  await new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js';
    s.onload = resolve;
    s.onerror = () => reject(new Error('Failed to load pdf-lib'));
    document.head.appendChild(s);
  });
}
const mmToPt = 2.83464567;                               // points per mm
const pageSize = { w: 100*mmToPt, h: 40*mmToPt };        // 100×40 mm label
async function loadLogoCandidates(name){
  const basePath = window.location.pathname.replace(/[^/]*$/, '');
  const candidates = [
    `${name}.png`, `${name}.PNG`,
    `${basePath}${name}.png`, `${basePath}${name}.PNG`,
    `assets/${name}.png`, `assets/${name}.PNG`
  ];
  for (const p of candidates){
    try{
      const res = await fetch(p, { cache:'no-cache' });
      if (res.ok) return res.arrayBuffer();
    }catch{/* ignore */}
  }
  return null;
}
// --- Load logos via <img> (works with file://) ---
function dataUrlFromImage(img){
  try{
    const canvas = document.createElement('canvas');
    canvas.width = img.naturalWidth || img.width;
    canvas.height = img.naturalHeight || img.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    return canvas.toDataURL('image/png');
  }catch(e){
    return null;
  }
}
async function loadLogoViaImage(name){
  const basePath = window.location.pathname.replace(/[^/]*$/, '');
  const candidates = [
    `${name}.png`, `${name}.PNG`,
    `${basePath}${name}.png`, `${basePath}${name}.PNG`,
    `assets/${name}.png`, `assets/${name}.PNG`
  ];
  for (const src of candidates){
    const ok = await new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const dataUrl = dataUrlFromImage(img);
        if(!dataUrl) return resolve(false);
        try{
          const bytes = dataURLToBytes(dataUrl);
          resolve(bytes);
        }catch{ resolve(false); }
      };
      img.onerror = ()=>resolve(false);
      img.src = src;
    });
    if (ok && ok.byteLength) return ok;
  }
  return null;
}
async function preloadLogos(){
  // 1) localStorage (if user uploaded once)
  let keliBytes = null, ceBytes = null;
  const kB64 = localStorage.getItem('logo_keli_b64');
  const cB64 = localStorage.getItem('logo_ce_b64');
  if (kB64) keliBytes = dataURLToBytes(kB64);
  if (cB64) ceBytes   = dataURLToBytes(cB64);

  // 2) try loading via <img> (works for file:// when placed next to index.html or in assets/)
  if (!keliBytes) keliBytes = await loadLogoViaImage('logokeli');
  if (!ceBytes)   ceBytes   = await loadLogoViaImage('ce');

  // 3) final fallback: fetch() (works when served over http)
  if (!keliBytes) keliBytes = await loadLogoCandidates('logokeli');
  if (!ceBytes)   ceBytes   = await loadLogoCandidates('ce');

  return { keliBytes, ceBytes };
}
async function generateLabelsPdf(rows){
  await ensurePdfLib();
  const { PDFDocument, StandardFonts } = PDFLib;
  const pdfDoc = await PDFDocument.create();
  const bold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
  const reg  = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const { keliBytes, ceBytes } = await preloadLogos();
  let keliImg, ceImg;
  if (keliBytes) keliImg = await pdfDoc.embedPng(keliBytes);
  if (ceBytes)   ceImg   = await pdfDoc.embedPng(ceBytes);
  const today = new Date().toLocaleDateString('en-GB').replaceAll('/','.');
  for (const r of rows){
    const qty = Number(r.quantity||0) || 1; // default to 1
    for (let i=0;i<qty;i++){
      const page = pdfDoc.addPage([pageSize.w, pageSize.h]);
      const margin = 16, spacing = 12;
      let y = pageSize.h - margin;
      if (keliImg) page.drawImage(keliImg, { x: margin, y: y-20, width: 60, height: 20 });
      if (ceImg)   page.drawImage(ceImg,   { x: (pageSize.w-30)/2, y: y-18, width: 30, height: 18 });
      page.drawText(today, { x: pageSize.w - margin - 60, y: y-14, size: 10, font: bold });
      page.drawLine({ start:{x:margin,y:y-24}, end:{x:pageSize.w-margin,y:y-24}, thickness: 0.8 });
      y -= (24 + spacing);
      const dim = (r.dimension && r.dimension.length) ? r.dimension : '—';
      const pos = r.position || '—';
      const ord = r.order_number || '—';
      const type = r.type || '';
      page.drawText(`Order No.: ${ord}   Pos: ${pos}   Dim: ${dim}`, { x: margin, y, size: 9, font: bold, maxWidth: pageSize.w - margin*2 });
      y -= 14;
      page.drawText(`Glass Type: ${type}`, { x: margin, y, size: 10, font: bold, maxWidth: pageSize.w - margin*2 });
      y -= 16;
      page.drawText('KELI ALBANIA PVC', { x: margin, y, size: 10, font: reg });
    }
  }
  return pdfDoc.save();
}

// Group rows within each order by (order_number, type, dimension).
// Sums quantity and area; position is set to "— (grouped)".
function groupWithinOrders(rows){
  const keyOf = (r) => `${(r.order_number||'').trim()}|${(r.type||'').trim()}|${(r.dimension||'').trim()}`;
  const map = new Map();
  for(const r of rows){
    const k = keyOf(r);
    if(!map.has(k)){
      map.set(k, {
        order_number: (r.order_number||'').trim(),
        type: r.type || '',
        dimension: r.dimension || '',
        position: '— (grouped)',
        quantity: 0,
        area: 0
      });
    }
    const agg = map.get(k);
    const qty = Number(r.quantity||0);
    const a = Number(r.area||0);
    agg.quantity += qty;
    // 'area' is already the TOTAL for the row; sum directly (don't multiply by qty again).
    agg.area += a;
  }
  return Array.from(map.values());
}

function toCSV(rows){
  const header = ['order_number','type','dimension','position','quantity','area'];
  const out = [header.join(',')];
  for(const r of rows){
    const vals = header.map(k => {
      let v = r[k];
      if(typeof v === 'string'){
        if(v.includes(',') || v.includes('"')) v = '"' + v.replace(/"/g,'""') + '"';
      }
      return v;
    });
    out.push(vals.join(','));
  }
  return out.join('\n');
}

function summarizeByOrder(rows){
  const byOrder = new Map();
  for(const r of rows){
    const key = (r.order_number || '').trim();
    if(!byOrder.has(key)) byOrder.set(key, []);
    byOrder.get(key).push(r);
  }
  return byOrder;
}

function totals(rows){
  const units = rows.reduce((a,b)=>a + (b.quantity || 0), 0);
  // 'area' is per-row TOTAL (ungrouped rows: already total; grouped rows: aggregated total)
  const area  = rows.reduce((a,b)=>a + (Number(b.area) || 0), 0);
  return {units, area};
}

function render(rows){
  const tableWrap = document.getElementById('tableWrap');
  const summaryEl = document.getElementById('summary');
  const orderInfo = document.getElementById('orderInfo');
  if(!rows.length){ tableWrap.innerHTML=''; summaryEl.innerHTML=''; orderInfo.textContent=''; window.__rows_displayed = []; return; }

  const useGrouped = !!document.getElementById('groupToggle')?.checked;
  const rowsForView = useGrouped ? groupWithinOrders(rows) : rows;
  window.__rows_displayed = rowsForView;

  // Group rows by order_number for rendering
  const groups = summarizeByOrder(rowsForView);
  const orderList = [...groups.keys()].filter(k => k && k.length).join(', ') || '—';
  const grand = totals(rowsForView);

  // Summary header (grand total)
  let summaryHtml = `Totals — <span class="pill">Units: ${grand.units}</span> <span class="pill">Area: ${grand.area.toFixed(3)} m²</span>`;
  if (groups.size > 1){
    summaryHtml += `<div class="muted small">Multiple orders: ${orderList}</div>`;
  }
  summaryEl.innerHTML = summaryHtml;
  orderInfo.textContent = groups.size === 1 ? `Order: ${orderList}` : `Orders: ${orderList}`;

  // Build HTML per group
  let html = '';
  for(const [order, rowsForOrder] of groups.entries()){
    const t = totals(rowsForOrder);
    if (groups.size > 1){
      html += `<h3 style="margin:16px 0 6px">${order || 'No order number'}</h3>`;
      html += `<div class="muted small">Units: ${t.units} • Area: ${t.area.toFixed(3)} m²</div>`;
    }
    html += '<table><thead><tr>' +
      '<th>#</th><th>order_number</th><th>type</th><th>dimension</th><th>position</th><th>quantity</th><th>area (m²)</th>' +
      '</tr></thead><tbody>';
    rowsForOrder.forEach((r,idx)=>{
      html += `<tr>
        <td>${idx+1}</td>
        <td class="mono">${r.order_number||''}</td>
        <td>${r.type||''}</td>
        <td class="mono">${(r.dimension && r.dimension.length) ? r.dimension : '—'}</td>
        <td class="mono">${r.position}</td>
        <td>${r.quantity}</td>
        <td>${Number(r.area).toFixed(3)}</td>
      </tr>`;
    });
    html += '</tbody></table>';
  }
  tableWrap.innerHTML = html;
}

async function callAPI(text){
  const status = document.getElementById('status');
  const errEl = document.getElementById('error');
  errEl.style.display='none';
  status.innerHTML = '<span class="spinner"></span> Extracting…';
  try{
    const res = await fetch(API_BASE + '/extract', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text})
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(t || ('HTTP '+res.status));
    }
    const data = await res.json();
    status.textContent = 'Done.';
    return data;
  }catch(e){
    status.textContent = '';
    errEl.style.display='block';
    errEl.textContent = 'Error: ' + e.message;
    throw e;
  }
}

document.getElementById('extract').addEventListener('click', async ()=>{
  const text = document.getElementById('input').value.trim();
  if(!text){ return; }
  try{
    const data = await callAPI(text);
    const rows = data.rows || [];
    window.__rows = rows;
    render(rows);
    const uniqOrders = Array.from(new Set((rows || []).map(r => (r.order_number || '').trim()).filter(Boolean)));
    document.getElementById('orderInfo').textContent = uniqOrders.length
      ? (uniqOrders.length === 1 ? ('Order: ' + uniqOrders[0]) : ('Orders: ' + uniqOrders.join(', ')))
      : 'Order number not detected.';
  }catch(e){}
});

document.getElementById('copyCsv').addEventListener('click', async ()=>{
  const rows = window.__rows_displayed && window.__rows_displayed.length ? window.__rows_displayed : (window.__rows || []);
  const csv = toCSV(rows);
  try{
    await navigator.clipboard.writeText(csv);
    document.getElementById('status').textContent = 'CSV copied.';
  }catch(e){
    document.getElementById('status').textContent = 'Copy failed. Select and copy manually.';
  }
});

document.getElementById('downloadCsv').addEventListener('click', ()=>{
  const rows = window.__rows_displayed && window.__rows_displayed.length ? window.__rows_displayed : (window.__rows || []);
  const csv = toCSV(rows);
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'order.csv';
  a.click();
});

document.getElementById('groupToggle').addEventListener('change', ()=>{
  const rows = window.__rows || [];
  render(rows);
});

// Print Labels button handler
document.getElementById('printLabels').addEventListener('click', async ()=>{
  const rows = (window.__rows_displayed && window.__rows_displayed.length)
    ? window.__rows_displayed
    : (window.__rows || []);
  if (!rows.length){
    document.getElementById('status').textContent = 'No rows to print — extract first.';
    return;
  }
  document.getElementById('status').textContent = 'Generating labels…';
  try{
    const pdfBytes = await generateLabelsPdf(rows);
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'labels.pdf';
    document.body.appendChild(a); a.click(); a.remove();
    document.getElementById('status').textContent = 'Labels ready (downloaded).';
  }catch(e){
    console.error(e);
    document.getElementById('status').textContent = 'Error generating labels (see console).';
  }
});

// Logo pickers -> store as DataURL in localStorage
(function(){
  const statusEl = document.getElementById('logoStatus');
  const setStatus = (msg) => { if(statusEl) statusEl.textContent = msg; };
  const keliInput = document.getElementById('logoKeli');
  const ceInput   = document.getElementById('logoCe');
  if (keliInput){
    keliInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      try{
        const dataUrl = await fileToDataURL(f);
        localStorage.setItem('logo_keli_b64', dataUrl);
        setStatus('Saved logokeli.png ✔');
      }catch(err){ setStatus('Failed to save logokeli'); }
    });
  }
  if (ceInput){
    ceInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      try{
        const dataUrl = await fileToDataURL(f);
        localStorage.setItem('logo_ce_b64', dataUrl);
        setStatus('Saved ce.png ✔');
      }catch(err){ setStatus('Failed to save ce'); }
    });
  }
})();
</script>
</body>
</html>
